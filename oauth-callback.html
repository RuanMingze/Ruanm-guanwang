<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuthç™»å½•å›è°ƒå¤„ç†</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #121220, #1a1a2e);
        }
        
        .callback-container {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 20px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            max-width: 500px;
        }
        
        body.dark-mode .callback-container {
            background: rgba(37, 37, 64, 0.1);
        }
        
        .loading {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        body.dark-mode .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            color: #ff6b6b;
            background: rgba(255,107,107,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        body.dark-mode .error {
            background: rgba(255,107,107,0.2);
        }
        
        .success {
            color: #51cf66;
            background: rgba(81,207,102,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        body.dark-mode .success {
            background: rgba(81,207,102,0.2);
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <h1>ğŸ” OAuthç™»å½•å¤„ç†ä¸­</h1>
        <div class="loading" id="status">æ­£åœ¨å¤„ç†ç™»å½•å›è°ƒ...</div>
        <div class="spinner" id="spinner"></div>
        <div id="result"></div>
    </div>

    <script>
        // Cookie æ“ä½œå‡½æ•°
        function setCookie(name, value, days) {
            try {
                // ä¼˜å…ˆä½¿ç”¨localStorageå­˜å‚¨
                localStorage.setItem(name, value);
                
                // åŒæ—¶è®¾ç½®Cookieä½œä¸ºå¤‡ä»½
                const d = new Date();
                d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                const expires = "expires=" + d.toUTCString();
                // æ·»åŠ æ›´å®Œæ•´çš„Cookieå±æ€§ä»¥ç¡®ä¿è·¨é¡µé¢è®¿é—®
                document.cookie = name + "=" + value + ";" + expires + ";path=/;SameSite=Lax";
            } catch (error) {
                console.log('å­˜å‚¨åŠŸèƒ½ä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®');
            }
        }
        
        function getCookie(name) {
            try {
                // ä¼˜å…ˆä» localStorage è¯»å–
                const localValue = localStorage.getItem(name);
                if (localValue !== null) {
                    return localValue;
                }
                
                // å¦‚æœ localStorage ä¸­æ²¡æœ‰ï¼Œå°è¯•ä» Cookie è¯»å–
                const cookieName = name + "=";
                const decodedCookie = decodeURIComponent(document.cookie);
                const cookieArray = decodedCookie.split(';');
                
                for (let i = 0; i < cookieArray.length; i++) {
                    let cookie = cookieArray[i];
                    while (cookie.charAt(0) === ' ') {
                        cookie = cookie.substring(1);
                    }
                    if (cookie.indexOf(cookieName) === 0) {
                        const value = cookie.substring(cookieName.length, cookie.length);
                        // åŒæ­¥åˆ° localStorage
                        try {
                            localStorage.setItem(name, value);
                        } catch (e) {}
                        return value;
                    }
                }
            } catch (error) {
                console.log('è¯»å–å­˜å‚¨æ•°æ®å¤±è´¥');
            }
            return "";
        }
        
        // ä¸»é¢˜åŒæ­¥åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥é¦–é¡µä¿å­˜çš„ä¸»é¢˜è®¾ç½®
            const savedTheme = getCookie('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark-mode');
            }
        });
        
        // è·å–URLå‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        const error_description = urlParams.get('error_description');
        const provider = getCookie('oauth_provider');
        
        const statusEl = document.getElementById('status');
        const spinnerEl = document.getElementById('spinner');
        const resultEl = document.getElementById('result');
        
        async function handleCallback() {
            try {
                if (error) {
                    throw new Error(error_description || error);
                }
                
                if (!code || !state || !provider) {
                    throw new Error('ç¼ºå°‘å¿…è¦çš„OAuthå‚æ•°');
                }
                
                // éªŒè¯stateå‚æ•°
                const savedState = getCookie('oauth_state');
                if (state !== savedState) {
                    throw new Error('æ— æ•ˆçš„stateå‚æ•°ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©');
                }
                
                statusEl.textContent = 'è·å–ç”¨æˆ·ä¿¡æ¯...';
                
                let userData = null;
                
                if (provider === 'github') {
                    // è·å–çœŸå®çš„GitHubç”¨æˆ·ä¿¡æ¯
                    userData = await fetchGitHubUserInfo(code);
                } else {
                    // å…¶ä»–å¹³å°ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆéœ€è¦é…ç½®æ—¶å†å®Œå–„ï¼‰
                    const simulatedUsers = {
                        microsoft: {
                            name: 'Microsoft User',
                            email: 'user@outlook.com',
                            avatar: 'https://via.placeholder.com/60/0078d4/ffffff?text=MS',
                            provider: 'microsoft'
                        },
                        google: {
                            name: 'Google User',
                            email: 'user@gmail.com',
                            avatar: 'https://via.placeholder.com/60/db4437/ffffff?text=G',
                            provider: 'google'
                        }
                    };
                    userData = simulatedUsers[provider];
                }
                
                if (!userData) {
                    throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
                
                // ä¿å­˜ç”¨æˆ·æ•°æ®
                setCookie('currentUser', JSON.stringify(userData), 30);
                console.log('ç”¨æˆ·æ•°æ®å·²ä¿å­˜åˆ°localStorageå’ŒCookie:', userData);
                
                // æ¸…ç†OAuthå‚æ•°
                localStorage.removeItem('oauth_provider');
                localStorage.removeItem('oauth_state');
                // åŒæ—¶æ¸…ç†Cookieä¸­çš„OAuthå‚æ•°
                document.cookie = "oauth_provider=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                document.cookie = "oauth_state=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                
                // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                spinnerEl.style.display = 'none';
                statusEl.textContent = 'âœ… ç™»å½•æˆåŠŸï¼';
                resultEl.innerHTML = `
                    <div class="success">
                        <h3>æ¬¢è¿ï¼Œ${userData.name}ï¼</h3>
                        <p>æ‚¨å·²æˆåŠŸä½¿ç”¨ ${provider.charAt(0).toUpperCase() + provider.slice(1)} ç™»å½•</p>
                        <p>æ­£åœ¨è·³è½¬å›é¦–é¡µ...</p>
                    </div>
                `;
                
                // ç«‹å³è·³è½¬å›ä¸»é¡µ
                window.location.href = 'home.html';
                
            } catch (error) {
                console.error('OAuthå›è°ƒé”™è¯¯:', error);
                
                spinnerEl.style.display = 'none';
                statusEl.textContent = 'âŒ ç™»å½•å¤±è´¥';
                resultEl.innerHTML = `
                    <div class="error">
                        <h3>ç™»å½•å¤±è´¥</h3>
                        <p>${error.message}</p>
                        <div style="margin-top: 15px;">
                            <button onclick="tryAgain()" style="margin-right: 10px; padding: 10px 20px; background: #4361ee; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                é‡æ–°ç™»å½•
                            </button>
                            <button onclick="goBack()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                è¿”å›é¦–é¡µ
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        // é‡æ–°ç™»å½•å‡½æ•°
        function tryAgain() {
            // æ¸…ç†å¯èƒ½å­˜åœ¨çš„OAuthå‚æ•°
            localStorage.removeItem('oauth_provider');
            localStorage.removeItem('oauth_state');
            // åŒæ—¶æ¸…ç†Cookieä¸­çš„OAuthå‚æ•°
            document.cookie = "oauth_provider=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            document.cookie = "oauth_state=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            
            // é‡æ–°å¼€å§‹GitHub OAuthæµç¨‹
            const clientId = 'Ov23liIzDeFcRlNZEMA4';
            const redirectUri = window.location.origin + '/oauth-callback';
            
            // ç”Ÿæˆæ–°çš„stateå‚æ•°
            const state = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            setCookie('oauth_state', state, 1);
            setCookie('oauth_provider', 'github', 1);
            
            // æ„é€ GitHub OAuthæˆæƒURLï¼ŒåŒ…å«æ›´è¯¦ç»†çš„scopes
            const scope = 'read:user,user:email'; // è¯»å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’Œé‚®ç®±
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&state=${state}&scope=${encodeURIComponent(scope)}`;
            
            // è·³è½¬åˆ°GitHubæˆæƒé¡µé¢
            window.location.href = authUrl;
        }
        
        function goBack() {
            window.location.href = 'home.html';
        }
        
        // è·å–GitHubç”¨æˆ·ä¿¡æ¯ - å¢å¼ºå®¹é”™å¤„ç†
        async function fetchGitHubUserInfo(code) {
            try {
                // GitHub OAuthé…ç½®
                const CLIENT_ID = 'Ov23li1BLwSUypXu95Au';
                const CLIENT_SECRET = '042b47eaaed933c4d4a774b5b96efecc40dc6822';
                
                statusEl.textContent = 'æ­£åœ¨è·å–è®¿é—®ä»¤ç‰Œ...';
                
                let tokenData = null;
                try {
                    // ç¬¬ä¸€æ­¥ï¼šç”¨æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œ
                    const tokenResponse = await fetch('https://github.com/login/oauth/access_token', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            client_id: CLIENT_ID,
                            client_secret: CLIENT_SECRET,
                            code: code
                        })
                    });
                    
                    tokenData = await tokenResponse.json();
                    
                    if (tokenData.error) {
                        throw new Error(`GitHub OAuthé”™è¯¯: ${tokenData.error_description || tokenData.error}`);
                    }
                } catch (tokenError) {
                    console.error('Tokenè·å–å¤±è´¥:', tokenError);
                    // å®¹é”™ï¼šå³ä½¿ä»¤ç‰Œè·å–å¤±è´¥ï¼Œä¹Ÿæä¾›åŸºæœ¬ç™»å½•ä¿¡æ¯
                    return createFallbackUser('ä»¤ç‰Œè·å–å¤±è´¥ï¼Œå¯èƒ½æ˜¯CORSé™åˆ¶æˆ–ç½‘ç»œé—®é¢˜');
                }
                
                const accessToken = tokenData.access_token;
                if (!accessToken) {
                    return createFallbackUser('æœªèƒ½è·å–è®¿é—®ä»¤ç‰Œ');
                }
                
                statusEl.textContent = 'æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...';
                
                let githubUser = null;
                try {
                    // ç¬¬äºŒæ­¥ï¼šä½¿ç”¨è®¿é—®ä»¤ç‰Œè·å–ç”¨æˆ·ä¿¡æ¯
                    // ä½¿ç”¨æ›´æ ‡å‡†çš„Authorizationå¤´æ ¼å¼
                    const userResponse = await fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'User-Agent': 'Ruanm-Guanwang-App'
                        }
                    });
                    
                    if (!userResponse.ok) {
                        throw new Error(`GitHub APIè¯·æ±‚å¤±è´¥: ${userResponse.status}`);
                    }
                    
                    githubUser = await userResponse.json();
                } catch (userError) {
                    console.error('GitHub APIè°ƒç”¨å¤±è´¥:', userError);
                    return createFallbackUser('ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥ï¼ŒCORSæˆ–APIé™åˆ¶');
                }
                
                // è·å–ç”¨æˆ·é‚®ç®±ï¼ˆå¯èƒ½éœ€è¦é¢å¤–è¯·æ±‚ï¼‰
                let email = githubUser.email;
                if (!email) {
                    try {
                        const emailResponse = await fetch('https://api.github.com/user/emails', {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'User-Agent': 'Ruanm-Guanwang-App'
                            }
                        });
                        
                        if (emailResponse.ok) {
                            const emails = await emailResponse.json();
                            // æŸ¥æ‰¾ä¸»é‚®ç®±
                            const primaryEmail = emails.find(e => e.primary) || emails[0];
                            email = primaryEmail?.email || 'private@github.com';
                        }
                    } catch (emailError) {
                        console.log('è·å–é‚®ç®±å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                        email = githubUser.login ? `${githubUser.login}@github.user` : 'private@github.com';
                    }
                }
                
                // æ„é€ ç”¨æˆ·æ•°æ® - å¢å¼ºå®¹é”™
                const userData = {
                    id: (githubUser.id || Date.now()).toString(),
                    name: githubUser.name || githubUser.login || 'Ruanmç”¨æˆ·', // ä¿®æ”¹ï¼šä½¿ç”¨é»˜è®¤åç§°"Ruanmç”¨æˆ·"
                    username: githubUser.login || 'github_user',
                    login: githubUser.login || 'github_user',
                    email: email || 'private@github.com',
                    avatar_url: githubUser.avatar_url || 'é˜®é“­æ³½å·¥å…·ç®±/icon.jpg', // ä¿®æ”¹ï¼šä½¿ç”¨é»˜è®¤å·¥å…·ç®±å›¾æ ‡
                    avatar: githubUser.avatar_url || 'é˜®é“­æ³½å·¥å…·ç®±/icon.jpg', // ä¿®æ”¹ï¼šä½¿ç”¨é»˜è®¤å·¥å…·ç®±å›¾æ ‡
                    provider: 'github',
                    html_url: githubUser.html_url || `https://github.com/${githubUser.login || 'unknown'}`,
                    profile_url: githubUser.html_url || `https://github.com/${githubUser.login || 'unknown'}`,
                    bio: githubUser.bio || null,
                    location: githubUser.location || null,
                    company: githubUser.company || null,
                    public_repos: githubUser.public_repos || 0,
                    followers: githubUser.followers || 0,
                    following: githubUser.following || 0,
                    created_at: githubUser.created_at || new Date().toISOString(),
                    updated_at: githubUser.updated_at || new Date().toISOString(),
                    theme: getCookie('theme') || 'light' // æ·»åŠ ä¸»é¢˜è®¾ç½®
                };
                
                // æ³¨æ„ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚æœéœ€è¦å°†ç”¨æˆ·æ•°æ®ä¿å­˜åˆ°åç«¯ï¼Œè¿™é‡Œåº”è¯¥å‘é€åˆ°æ‚¨çš„åç«¯æœåŠ¡å™¨
                // ç¤ºä¾‹ä»£ç ï¼ˆå¦‚æœéœ€è¦åç«¯åŒæ­¥ï¼‰ï¼š
                /*
                try {
                    const backendUrl = 'http://your-windows-server-ip:3001'; // è¯·æ›¿æ¢ä¸ºæ‚¨çš„æœåŠ¡å™¨IP
                    await fetch(backendUrl + '/api/user/github', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(userData)
                    });
                } catch (syncError) {
                    console.log('ç”¨æˆ·æ•°æ®åŒæ­¥åˆ°åç«¯å¤±è´¥:', syncError);
                }
                */
                
                console.log('GitHubç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ:', userData);
                return userData;
                
            } catch (error) {
                console.error('è·å–GitHubç”¨æˆ·ä¿¡æ¯å®Œå…¨å¤±è´¥:', error);
                return createFallbackUser('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ›å»ºå¤‡ç”¨ç”¨æˆ·ä¿¡æ¯ï¼ˆå®¹é”™æœºåˆ¶ï¼‰
        function createFallbackUser(errorMsg) {
            return {
                id: 'github_fallback_' + Date.now(),
                name: 'Ruanmç”¨æˆ·', // ä¿®æ”¹ï¼šä½¿ç”¨é»˜è®¤åç§°"Ruanmç”¨æˆ·"
                username: 'github_authorized_user',
                login: 'github_authorized_user',
                email: 'authorized@github.com',
                avatar_url: 'é˜®é“­æ³½å·¥å…·ç®±/icon.jpg', // ä¿®æ”¹ï¼šä½¿ç”¨é»˜è®¤å·¥å…·ç®±å›¾æ ‡
                avatar: 'é˜®é“­æ³½å·¥å…·ç®±/icon.jpg', // ä¿®æ”¹ï¼šä½¿ç”¨é»˜è®¤å·¥å…·ç®±å›¾æ ‡
                provider: 'github',
                html_url: 'https://github.com',
                profile_url: 'https://github.com',
                bio: null,
                location: null,
                company: null,
                public_repos: 0,
                followers: 0,
                following: 0,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
                error: errorMsg,
                note: 'æˆæƒæˆåŠŸï¼Œä½†è·å–è¯¦ç»†ä¿¡æ¯å¤±è´¥ã€‚è¯·åœ¨HTTPSç¯å¢ƒä¸‹ä½¿ç”¨å®Œæ•´åŠŸèƒ½ã€‚',
                theme: getCookie('theme') || 'light' // æ·»åŠ ä¸»é¢˜è®¾ç½®
            };
        }
        
        // é¡µé¢åŠ è½½åå¤„ç†å›è°ƒ
        if (code || error) {
            handleCallback();
        } else {
            statusEl.textContent = 'âŒ æ— æ•ˆçš„OAuthå›è°ƒ';
            spinnerEl.style.display = 'none';
            resultEl.innerHTML = `
                <div class="error">
                    <p>è¿™ä¸ªé¡µé¢ç”¨äºå¤„ç†OAuthç™»å½•å›è°ƒ</p>
                    <p>è¯·ä»é¦–é¡µçš„ç™»å½•æŒ‰é’®å¼€å§‹ç™»å½•æµç¨‹</p>
                    <div style="margin-top: 15px;">
                        <button onclick="tryAgain()" style="margin-right: 10px; padding: 10px 20px; background: #4361ee; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ç«‹å³ç™»å½•
                        </button>
                        <button onclick="goBack()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            è¿”å›é¦–é¡µ
                        </button>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
